<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üß≠ Ascendente Crypto</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1, h3 { color: #333; margin-bottom: 10px; }
    .filtros, .anotacoes { margin-bottom: 15px; }
    .filtros input { margin-right: 10px; padding: 6px; width: 150px; }
    .bloco { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .item { padding: 8px 12px; border-radius: 4px; font-weight: bold; }
    .green { background: #c8e6c9; }
    .yellow { background: #fff9c4; }
    .orange { background: #ffe0b2; }
    #tabela_wrapper { background: white; padding: 10px; border-radius: 4px; }
    .anotacoes textarea { width: 100%; height: 80px; padding: 6px; }
  </style>
</head>
<body>

  <h1>üß≠ Ascendente Crypto</h1>
  
  <div class="filtros">
    <input type="text" id="filtroSimbolo" placeholder="S√≠mbolo ou ID">
    <input type="number" id="filtroMin" placeholder="Min Ranking">
    <input type="number" id="filtroMax" placeholder="Max Ranking">
    <button onclick="aplicarFiltros()">Filtrar</button>
    <button onclick="resetarFiltros()">Limpar</button>
  </div>

  <div>
    <h3>üé® Top 5 por Cor</h3>
    <div class="bloco" id="blocoCoresVerde"></div>
    <div class="bloco" id="blocoCoresRestante"></div>
  </div>

  <div>
    <h3>üî• Top Destaques (Avan√ßos Consecutivos)</h3>
    <div class="bloco" id="blocoAvanco"></div>
  </div>

  <div>
    <h3>üìà Top 5 Avan√ßo de Ranking</h3>
    <div class="bloco" id="blocoRanking"></div>
  </div>

  <table id="tabela" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>ID</th><th>S√≠mbolo</th><th>Pre√ßo</th><th>Link</th>
        <th>Ranking Anterior</th><th>Diferen√ßa</th><th>Ranking Atual</th><th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="anotacoes">
    <h3>üìù Minhas Anota√ß√µes</h3>
    <textarea id="notaUsuario" placeholder="Escreva suas observa√ß√µes..."></textarea>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbwuJPGDNy0bpnLo3x78SXyQqsL49Wy6O2keJwl0v2Z6Tb1Bf8zzIn5_Hep-8mYQqfVF/exec';
    let dadosOriginais = [];
    let tabela;

    $(document).ready(async () => {
      const resp = await fetch(API);
      dadosOriginais = await resp.json();
      montarPainel();
      carregarTabela(dadosOriginais);
      carregarNotas();
    });

    function montarPainel() {
      const verde = dadosOriginais.filter(m => m.diferenca >= 10).slice(0, 5);
      const amarelo = dadosOriginais.filter(m => m.diferenca >= 5 && m.diferenca < 10).slice(0, 5);
      const laranja = dadosOriginais.filter(m => m.diferenca > 0 && m.diferenca < 5).slice(0, 5);

      const blocoVerde = document.getElementById('blocoCoresVerde');
      verde.forEach(m => {
        const div = document.createElement('div');
        div.className = 'item green';
        div.textContent = `${m.simbolo} (${m.diferenca})`;
        blocoVerde.appendChild(div);
      });

      const blocoRestante = document.getElementById('blocoCoresRestante');
      [...amarelo, ...laranja].forEach(m => {
        const div = document.createElement('div');
        div.className = 'item ' + (m.diferenca >= 5 ? 'yellow' : 'orange');
        div.textContent = `${m.simbolo} (${m.diferenca})`;
        blocoRestante.appendChild(div);
      });

      const destaques = dadosOriginais
        .filter(m => typeof m.status === 'string' && m.status.includes('üîº'))
        .sort((a, b) => b.status.length - a.status.length)
        .slice(0, 5);
      const blocoAvanco = document.getElementById('blocoAvanco');
      destaques.forEach(m => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = `${m.simbolo} ${m.status}`;
        blocoAvanco.appendChild(div);
      });

      const topRanking = [...dadosOriginais]
        .sort((a, b) => b.diferenca - a.diferenca)
        .filter(m => m.diferenca > 0)
        .slice(0, 5);
      const blocoRanking = document.getElementById('blocoRanking');
      topRanking.forEach(m => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = `${m.simbolo} (+${m.diferenca})`;
        blocoRanking.appendChild(div);
      });
    }

    function carregarTabela(dados) {
      tabela = $('#tabela').DataTable({
        data: dados.filter(m => m.diferenca > 0),
        columns: [
          { data: 'id' },
          { data: 'simbolo' },
          { data: 'preco', render: v => '$' + parseFloat(v).toFixed(4) },
          { data: 'link', render: v => '<a href="'+v+'" target="_blank">üîó</a>' },
          { data: 'rankingAnterior' },
          { data: 'diferenca' },
          { data: 'rankingAtual' },
          { data: 'status' }
        ],
        destroy: true,
        scrollX: true,
        dom: 'Bfrtip',
        buttons: ['csvHtml5', 'excelHtml5'],
        ordering: true,
        paging: false,
        info: false,
        createdRow: (row, m) => {
          if (m.diferenca >= 10) $(row).addClass('green');
          else if (m.diferenca >= 5) $(row).addClass('yellow');
          else $(row).addClass('orange');
        }
      });
    }

    function aplicarFiltros() {
      const sim = $('#filtroSimbolo').val().toUpperCase();
      const min = parseInt($('#filtroMin').val()) || -Infinity;
      const max = parseInt($('#filtroMax').val()) || Infinity;
      tabela.column(1).search(sim);
      tabela.draw();
      tabela.rows().every(rowIdx => {
        const data = tabela.row(rowIdx).data();
        if (data.rankingAtual < min || data.rankingAtual > max) {
          $(tabela.row(rowIdx).node()).hide();
        } else {
          $(tabela.row(rowIdx).node()).show();
        }
      });
    }

    function resetarFiltros() {
      $('#filtroSimbolo, #filtroMin, #filtroMax').val('');
      tabela.search('').columns().search('').draw();
      tabela.rows().every(rowIdx => $(tabela.row(rowIdx).node()).show());
    }

    function carregarNotas() {
      const txt = localStorage.getItem('notasAscCrypto');
      if (txt) $('#notaUsuario').val(txt);
      $('#notaUsuario').on('input', function() {
        localStorage.setItem('notasAscCrypto', $(this).val());
      });
    }
  </script>

</body>
</html>
